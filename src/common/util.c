/*
 * This file is part of cve-check-tool
 *
 * Copyright Â© 2015-2016 Intel Corporation
 *
 * cve-check-tool is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * As an additional permission, the right to link to OpenSSL is granted.
 */

#define _GNU_SOURCE
#include <stdio.h>
#include <time.h>

#include "util.h"

int64_t parse_iso8601_date(const char *date)
{
        char tzchar = 0;
        int tzhour, tzmin = -1;
        int tzoffset = 0;
        struct tm tm = { 0 };
        time_t ret_time = -1;
        /* deliberately drop extra precision later */
        float seconds = -1;

        if (sscanf(date,
                   "%4d-%2d-%2dT%2d:%2d:%g%c%2d:%2d",
                   &tm.tm_year,
                   &tm.tm_mon,
                   &tm.tm_mday,
                   &tm.tm_hour,
                   &tm.tm_min,
                   &seconds,
                   &tzchar,
                   &tzhour,
                   &tzmin) != 9) {
                return -1;
        }

        tm.tm_year -= 1900;
        tm.tm_mon--;
        tm.tm_sec = (int)seconds;
        if (tm.tm_sec > 59) {
                tm.tm_sec = 59;
        }

        if (tzhour > 0) {
                tzoffset = 3600 * tzhour; /* 60*60*tzhour */
        }
        if (tzmin > 0) {
                tzoffset += 60 * tzmin;
        }

        ret_time = mktime(&tm);
        if (tzchar == '+') {
                tzoffset = -(tzoffset);
        } else if (tzchar != '-') {
                return -1;
        }
        return ret_time + tzoffset;
}

/*
 * Editor modelines  -  https://www.wireshark.org/tools/modelines.html
 *
 * Local variables:
 * c-basic-offset: 8
 * tab-width: 8
 * indent-tabs-mode: nil
 * End:
 *
 * vi: set shiftwidth=8 tabstop=8 expandtab:
 * :indentSize=8:tabSize=8:noTabs=true:
 */
