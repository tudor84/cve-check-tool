/*
 * This file is part of cve-check-tool
 *
 * Copyright Â© 2016 Intel Corporation
 *
 * cve-check-tool is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * As an additional permission, the right to link to OpenSSL is granted.
 */

#pragma once

#include <nica.h>
#include <stdio.h>

/**
 * CveTemplateParser
 *
 * Fed a template, this parser will compile a series of contexts to be
 * used later in a render loop
 */
typedef struct CveTemplateParser CveTemplateParser;

/**
 * CveTemplateContext
 *
 * The context must be populated with key->value mappings to enable the logic
 * and content for the main render function.
 */
typedef struct CveTemplateContext CveTemplateContext;

/**
 * Construct a new CveTemplateParser
 */
CveTemplateParser *cve_template_parser_new(void);

/**
 * Free a previously allocated CveTemplateParser and any compiled resources
 */
void cve_template_parser_free(CveTemplateParser *parser);

/**
 * Compile this template parser from the given @buffer of size @length
 */
bool cve_template_parser_load(CveTemplateParser *parser, const char *buffer, ssize_t length);

/**
 * Render the current parser to the given output stream
 */
bool cve_template_parser_render(CveTemplateParser *parser, CveTemplateContext *context,
                                FILE *stream);

/**
 * Construct a new root template context
 */
CveTemplateContext *cve_template_context_new(void);

/**
 * Add a key->value mapping to the context with the string @value
 */
bool cve_template_context_add_string(CveTemplateContext *context, const char *key, char *value);

/**
 * Add a key->value mapping to the context with the boolean @value
 */
bool cve_template_context_add_bool(CveTemplateContext *context, const char *key, bool value);

/**
 * Add a key->value mapping to the context with a TemplateContext child @value
 */
bool cve_template_context_add_child(CveTemplateContext *context, const char *key,
                                    CveTemplateContext *child);

/**
 * Add an item to list with the name of @key.
 * If the list does not already exist, it will be created. Each node in the list must be
 * a full CveTemplateContext, which will be the root context in each iteration
 */
bool cve_template_context_add_list(CveTemplateContext *context, const char *key,
                                   CveTemplateContext *node);

/**
 * Free a previously allocated template context and any associated resources
 */
void cve_template_context_free(CveTemplateContext *context);

/**
 * Convenience macros
 */
DEF_AUTOFREE(CveTemplateParser, cve_template_parser_free)
DEF_AUTOFREE(CveTemplateContext, cve_template_context_free)
