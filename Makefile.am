include $(top_srcdir)/common.mk

ACLOCAL_AMFLAGS = -I m4

NVD_FULL_FILES = \
	${top_srcdir}/tests/data/datasources/nvd_full/mkfk.sh \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2002.meta   \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2002.xml.gz \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2003.meta   \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2003.xml.gz \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2004.meta   \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2004.xml.gz \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2005.meta   \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2005.xml.gz \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2006.meta   \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2006.xml.gz \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2007.meta   \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2007.xml.gz \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2008.meta   \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2008.xml.gz \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2009.meta   \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2009.xml.gz \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2010.meta   \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2010.xml.gz \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2011.meta   \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2011.xml.gz \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2012.meta   \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2012.xml.gz \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2013.meta   \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2013.xml.gz \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2014.meta   \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2014.xml.gz \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2015.meta   \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2015.xml.gz \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2016.meta   \
	${top_srcdir}/tests/data/datasources/nvd_full/nvdcve-2.0-2016.xml.gz

EXTRA_DIST = \
	${top_srcdir}/README.md \
	${top_srcdir}/LICENSE \
	${top_srcdir}/common.mk \
	${top_srcdir}/tests/data/common/nvdcve-2.0-2002.meta \
	${top_srcdir}/tests/data/common/nvdcve-2.0-2002.meta.xtests \
	${top_srcdir}/tests/data/common/Test.gz \
	${top_srcdir}/tests/data/datasources/nvd/nvdcve-2.0-2016.meta \
	${top_srcdir}/tests/data/datasources/nvd/nvdcve-2.0-2016.xml.gz \
	${top_srcdir}/tests/data/datasources/nvd/broken.xml \
	$(NVD_FULL_FILES)

NULL =
CLEANFILES =
AM_CFLAGS =
SUBDIRS = src

if COVERAGE
coverage:
	mkdir -p coverage
	lcov --compat-libtool --directory . --capture --output-file coverage/report
	lcov --remove coverage/report 'tests/*' '/usr/*' --output-file coverage/report
	genhtml -o coverage/ coverage/report
endif

distclean-local:
	rm -fv ${top_builddir}/tests/data/common/*.gunzip
	rm -fv ${top_builddir}/tests/data/common/Test.fetch.gz
	rm -rf ${top_builddir}/tests/data/datasources/BULK/


if ENABLE_UNIT_TESTS

TESTS = \
	check_common \
	check_nvd \
	check_datasource

check_PROGRAMS = $(TESTS)

# Core tests
check_common_SOURCES = \
	tests/check-common.c

check_common_CFLAGS = \
	$(CHECK_CFLAGS) \
	$(AM_CFLAGS)

check_common_LDADD = \
	$(CHECK_LIBS) \
	src/common/libcvecommon.la

# NVD (SAX) test
check_nvd_SOURCES = \
	tests/check-nvd.c

check_nvd_CFLAGS = \
	$(CHECK_CFLAGS) \
	$(AM_CFLAGS) \
	$(DATASOURCE_NVD_CFLAGS) \
	-I ${top_srcdir}/src/datasource/nvd

check_nvd_LDADD = \
	$(CHECK_LIBS) \
	src/common/libcvecommon.la \
	src/datasource/libcvedatasource.la

# Datasource test
check_datasource_SOURCES = \
	tests/check-datasource.c

check_datasource_CFLAGS = \
	$(CHECK_CFLAGS) \
	$(AM_CFLAGS) \
	-I ${top_srcdir}/src/datasource

check_datasource_LDADD = \
	$(CHECK_LIBS) \
	src/common/libcvecommon.la \
	src/datasource/libcvedatasource.la

@VALGRIND_CHECK_RULES@

endif
